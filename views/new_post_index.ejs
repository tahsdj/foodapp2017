<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
	<title>jiabeng</title>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
	<link rel="stylesheet" href="../../css/new_post_screen.css">
	<script src="https://unpkg.com/vue"></script>
	<script>
		function addressGps(place){
			console.log(place)
			var myLatLng = new google.maps.LatLng(22.9996873, 120.21809469999994)
			var myGeocoder = new google.maps.Geocoder();
			var address = place
			var myMap = new google.maps.Map(document.getElementById("my_map"),{
				center: myLatLng,
				zoom: 15,
				mapTypeId: google.maps.MapTypeId.ROADMAP
			})
			myGeocoder.geocode({address: address}, function(results, status) {
		          if (status === 'OK') {
			            myMap.setCenter(results[0].geometry.location);
			            var myMarker = new google.maps.Marker({
				            map: myMap,
				            position: results[0].geometry.location
			            });
		          } else {
		            //alert('Geocode was not successful for the following reason: ' + status);
		          }
		        })
		}
	</script>
</head>
<body onload='addressGps("<%=post.place%>")'>
	<div id="app">
			<div id="banner">
				<div class="filter">
				</div>
				<header>
					<a href="../"><img src="../img/app_logo_deepBlue.png" alt="" class="logo"></a>
					<img src="../img/list_icon.png" alt="" class="list">
				</header>
				<br>
				<img src="<%=post.imgURL%>" alt="" class="food-photo" >
				<br>
			</div>
			<div class="post-board">
				<div class="poster">
					<img src="<%=post.poster_img%>" alt="" class="poster-img">
					<a><%= post.poster %></a>
				</div>
				<h2 class="title"><%= post.title %></h2>
				<%if( post.like_list.indexOf(user.id) == -1){%>
					<i class="fa fa-heart" aria-hidden="true" style="color: grey"><%=post.likes%></i>
				<%}else{%>
					<i class="fa fa-heart" aria-hidden="true" style="color: #F03861"><%=post.likes%></i>
				<%}%>
				<br>
				<br>
				<hr>
				<div class="info">
					<ul>詳細內容<br>
						<li><label for=""><i class="fa fa-calendar" aria-hidden="true"></i></label><%= post.time %></li><br><br>
						<li><label for=""><i class="fa fa-map-marker" aria-hidden="true" style="padding: 0px 5px"></i></label><%= post.place %></li><br><br>
						<li><label for=""><i class="fa fa-users" aria-hidden="true"></i></label><%= post.people_limit %></li><br><br>
						<li><label for="">募集項目:</label>
						<%= post.item_list %></li><br><br>
						<li><label for="">介紹:</label>
						<%= post.intro %>
						</li><br>
						<br>
						<% let joinList = post.join_list%>
						<li><label id ="join-list" style="cursor: pointer;"><a>參加名單</a></label></li><br><br>
					</ul>
				</div>
			</div>
			<br>
			<div id="my_map"></div>
			<br>
			<%if(post.poster == user.name){%>
				<button type="submit" id="finish">FINISH</button>
				<button type="submit" id="close">CLOSE</button>
			<%}else{%>
				<button type="submit" id="join">JOIN</button>
			<%}%>
		<div class="list-board">
			<i class="fa fa-times" aria-hidden="true"></i>
			<ul>
				<% if(loginStatus){%>
					<li class = "user-profile"><img src="<%=user.img%>" alt="" class = "user-img"><br><h3 class = "user-name"><%= user.name%></h3></li>
				<%}else{%>
					<li class="login"><i class="fa fa-facebook" aria-hidden="true" style="color: white"></i>登入</li>
					<li class ="signup"><i class="fa fa-facebook" aria-hidden="true" style="color: white"></i>註冊</li>
				<%}%>
				<a href="./edit"><li class="edit"><i class="fa fa-pencil-square-o" aria-hidden="true"></i></li></a>
				<li><i class="fa fa-sticky-note-o note" aria-hidden="true"></i><br>
				<div class="note-board" style="display: none">
				</div>
				</li>
			</ul>
		</div>
		<div class="list_filter" style="display: none">
			<div class="join-list-board">
				<i class="fa fa-times cross" aria-hidden="true" id="cross"></i>
				<ul>
					<% for(let i = 0 ; i < post.join_list.length ; i++ ) {%>
					<li><img src="<%=post.join_list[i].img%>" alt=""><h3 class="name"><%=post.join_list[i].name%></h3> <h3 class="offer">提供: <%=post.join_list[i].offer%></h3></li>
					<%}%>
					<%if(post.join_list.length == 0) {%>
						<li>目前沒有人參與</li>
					<%}%>
				</ul>
			</div>
		</div>
		<div class="join_filter" style="display: none">
			<div id="user-input">
				<i class="fa fa-times cross" aria-hidden="true"></i>
				<input type="text" class="postid" name="postid" value="<%=post.id%>" style ="display:none" >
				<input type="text" class="userid" name="userid" value="<%=user.id%>" style ="display:none" >
				<input type="text" class="username" name="name" value="<%=user.name%>" style ="display:none">
				<input type="text" class="userimg" name="img" value="<%=user.img%>" style ="display:none">
				<input type="text" class="food" name="food" placeholder="你想貢獻的食材">
				<br>
				<br>
				<button id="continue">CONTINUE</button>
			</div>
		</div>
	</div>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script type="text/javascript" src="//maps.googleapis.com/maps/api/js?key=AIzaSyAxSB6ubUXYlbNl67cImH8aJk4cYEafjoM&sensor=true"></script>
	<script>
		$(document).ready(function() {
			$('#join').click(()=>{
				$('.join_filter').css({
					"display": "initial"
				})
			})
			$('#user-input>.fa-times').click(()=>{
				$('.join_filter').css({
					"display": "none"
				})
			})
			$('#join-list').click(()=>{
				$('.list_filter').css({
					"display": "initial"
				})
			})

			$('#cross').click(()=>{
				$('.list_filter').css({
					"display": "none"
				})
			})

			$('.list').click(()=>{
				console.log('click')
				$('.list-board').css({
					'display': 'initial'
				})
			})

			$('.list-board >.fa-times').click(()=>{
				$('.list-board').css({
					'display': 'none'
				})
			})

			$('.fa-heart').click(function(){
				let id = '' + $('#user-input > .postid').val()
				let now_likes = parseInt($(this).text(), 10) //()=>{} $(this) will get wrong content
				let content = {}
					content.id = id
					content.user = $('#user-input > .userid').val() //get id through ejs variable
				let _this = $(this)
				$.ajax({
			        type: 'POST',
			        data: JSON.stringify(content),
			        contentType: 'application/json',
			        url: '../like_clicked',
			        success: function(data) {
			        	console.log(data)
			        	if(data){
			        		now_likes++
			        		_this.css({
			        			'color': '#F03861'
			        		})
			        	}
			        	else{
			        		now_likes--
			        		_this.css({
			        			'color': 'grey'
			        		})
			        	}
			            _this.text(now_likes)
			        }
			    })
			})

			$('#continue').click(()=>{
				let content = {}
				//let postID
				let postID = '' + $('#user-input > .postid').val()
				content.id = $('#user-input > .userid').val()
				content.name = $('#user-input > .username').val()
				content.img = $('#user-input > .userimg').val()
				content.offer = $('#user-input > .food').val()
				$.ajax({
			        type: 'POST',
			        data: JSON.stringify(content),
			        contentType: 'application/json',
			        url: './join_event/'+postID+'',
			        success: function(data) {
			            $('#user-input').html('<h3 style="padding: 10px">成功加入</h3>')
			            setTimeout(()=>{window.location = '/'},2000)
			        }
			    })
			})

			$('.note').click(function(){
				let content = {}
				content.id = $('#user-input > .userid').val()
				$.ajax({
			        type: 'POST',
			        data: JSON.stringify(content),
			        contentType: 'application/json',
			        url: '../find_my_event',
			        success: function(data) {
			        	$('.note-board').css({
			        		"display": "initial"
			        	})
			        	.css({
			        		"display": "inline-block"
			        	})
			        	.html('')
			        	for (let i = 0 ; i < data.my_post.length ; i++ ){
			        		let context = '<a href="'+data.my_post[i].link+'">'+
											'<div class="each-note">'+
												'<i class="fa fa-thumb-tack" aria-hidden="true"></i>'+
												'<h3>'+data.my_post[i].post_title+'</h3>'+
											'</div>'+
											'</a>'
			        		$('.note-board').append(context)
			        	}
			        	for (let i = 0 ; i < data.attend_list.length ; i++ ){
			        		let context = '<a href="'+data.attend_list[i].link+'">'+
											'<div class="each-note">'+
												'<i class="fa fa-thumb-tack" aria-hidden="true"></i>'+
												'<h3>'+data.attend_list[i].post_title+'</h3>'+
											'</div>'+
											'</a>'
			        		$('.note-board').append(context)
			        	}
			     		if(data.my_post.length == 0 && data.attend_list.length == 0){
			     			$('.note-board').html('<div class="each-note">目前沒有活動</div>')
			     		}
			           /* $('.note').html('<li style="padding: 10px">'+data+'</li>')*/
			            //setTimeout(()=>{window.location = '/'},2000)
			        }
			    })
			})
		})
		/*function addressGps(place){
			console.log(place)
			var myLatLng = new google.maps.LatLng(22.9996873, 120.21809469999994)
			var myGeocoder = new google.maps.Geocoder();
			var address = place
			var myMap = new google.maps.Map(document.getElementById("my_map"),{
				center: myLatLng,
				zoom: 15,
				mapTypeId: google.maps.MapTypeId.ROADMAP
			})
			myGeocoder.geocode({address: address}, function(results, status) {
		          if (status === 'OK') {
			            myMap.setCenter(results[0].geometry.location);
			            var myMarker = new google.maps.Marker({
				            map: myMap,
				            position: results[0].geometry.location
			            });
		          } else {
		            //alert('Geocode was not successful for the following reason: ' + status);
		          }
		        })
		}*/
	</script>
</body>
</html>