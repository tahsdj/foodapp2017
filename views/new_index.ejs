<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
	<title>jiabeng</title>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
	<link rel="stylesheet" href="css/new_index_screen.css">
	<script src="https://unpkg.com/vue"></script>
</head>
<body>
	<div id="app">
		<div id="banner">
			<div class="filter">
			</div>
			<header>
				<a href="./"><img src="img/app_logo_deepBlue.png" alt="" class="logo"></a>
				<img src="img/list_icon.png" alt="" class="list">
			</header>
			<br>
			<img src="img/LOGO-03.png" alt="" class="plate-logo"><br>
			<form id="submit">
				<input type="text" placeholder="搜尋家中食材" class="search">
			</form>
			<br>
			<h2>分享食材、與朋友一起料理</h2>
		</div>
		<input type="text" class="postid" name="postid" value="<%=post.id%>" style ="display:none" >
		<input type="text" class="userid" name="userid" value="<%=user.id%>" style ="display:none" >
		<input type="text" class="username" name="name" value="<%=user.name%>" style ="display:none">
		<input type="text" class="userimg" name="img" value="<%=user.img%>" style ="display:none">
		<div class="list-board">
			<i class="fa fa-times" aria-hidden="true"></i>
			<ul>
				<% if(loginStatus){%>
					<li class = "user-profile"><img src="<%=user.img%>" alt="" class = "user-img"><br><h3 class = "user-name"><%= user.name%></h3></li>
				<%}else{%>
					<a href="./login"><li class="login"><i class="fa fa-facebook" aria-hidden="true" style="color: white"></i>登入</li></a>
					<a href="./login"><li class ="signup"><i class="fa fa-facebook" aria-hidden="true" style="color: white"></i>註冊</li></a>
				<%}%>
				<a href="./edit"><li class="edit"><i class="fa fa-pencil-square-o" aria-hidden="true"></i></li></a>
				<li><i class="fa fa-sticky-note-o note" aria-hidden="true"></i><br>
				<div class="note-board" style="display: none">
				</div>
				</li>
			</ul>
		</div>
		<!--<div class="create-event" title="create an event">
			<a href="./edit"><i class="fa fa-plus" aria-hidden="true"></a></i>
		</div>-->
		<div class="post-board">
			<% for ( let i = 0 ; i < post.length ; i++) {%>
				<div class="post">
					<a href="./food/<%=post[i].id%>"><img src="<%= post[i].imgURL%>" alt="" class = "food-img"></a>
					<h3 class="title"><%= post[i].title%></h3><br>
					<img src="<%=post[i].poster_img%>" alt="" class="profile">
					<%if( post[i].like_list.indexOf(user.id) == -1){%>
					<i class="fa fa-heart" aria-hidden="true" style="color: grey"><%=post[i].likes%></i>
				<%}else{%>
					<i class="fa fa-heart" aria-hidden="true" style="color: #F03861"><%=post[i].likes%></i>
				<%}%>
				</div>
			<%}%>
		</div>
		<% let userid = user.id%>
	</div>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script>
		$(function(){
			$('.fa-star').click(function(){
				let link = $(this).siblings('a').attr('href').split("/")
				let id = link[2]
				let now_likes = parseInt($(this).text(), 10)
				let content = {}
					content.id = id
					content.user = ''+<%= userid %> //get id through ejs variable
				$.ajax({
			        type: 'POST',
			        data: JSON.stringify(content),
			        contentType: 'application/json',
			        url: './like_clicked',
			        success: function(data) {
			        	console.log(data)
			        	if(data){
			        		now_likes++
			        		$('.fa-star').css({
			        			'color': '#FFD480'
			        		})
			        	}
			        	else{
			        		now_likes--
			        		$('.fa-star').css({
			        			'color': 'grey'
			        		})
			        	}
			            $('.fa-star').text(now_likes)
			        }
			    })
			})

			//close the side list
			$('.list-board >.fa-times').click(()=>{
				$('.list-board').css({
					'display': 'none'
				})
			})

			//open the side list
			$('.list').click(()=>{
				console.log('click')
				$('.list-board').css({
					'display': 'initial'
				})
			})

			//search
			$('#submit').on('submit',(event)=>{
					event.preventDefault()
					let obj = {}
					obj.content = $('.search').val()
					$.ajax({
			            type: 'POST',
			            data: JSON.stringify(obj),
			            contentType: 'application/json',
			            url: './search',
			            success: function(data) {
			                console.log(data)
			            
			                if(data.length == 0 ){
			                	$('.post-board').html('找不到有相關食材的文章')
			                }else{
			                	$('.post-board').html('')
			                	for(let i = 0 ; i < data.length ; i++){
				                	let post = '<div class="post">' +
					                				'<a href="./food/'+data[i].id+'"><img src="'+data[i].imgURL+'%>" alt="" class = "food-img"></a>' +
					                				'<h3 class="title">'+data[i].title+'</h3>' +
					                				'<img src="'+data[i].poster_img+'" alt="" class="profile">' +
					                				'<i class="fa fa-star" aria-hidden="true">'+ data[i].likes+'</i>'+
				                				'</div>'
				                	$('.post-board').append(post)
				                } 
			                }
			            }
			        })
			})

			$('.note').click(function(){
				let content = {}
				content.id = $('.userid').val()
				console.log(content.id)
				$.ajax({
			        type: 'POST',
			        data: JSON.stringify(content),
			        contentType: 'application/json',
			        url: './find_my_event',
			        success: function(data) {
			        	$('.note-board').css({
			        		"display": "initial"
			        	})
			        	.css({
			        		"display": "inline-block"
			        	})
			        	.html('')
			        	for (let i = 0 ; i < data.my_post.length ; i++ ){
			        		let context = '<a href="'+data.my_post[i].link+'">'+
											'<div class="each-note">'+
												'<i class="fa fa-thumb-tack" aria-hidden="true"></i>'+
												'<h3>'+data.my_post[i].post_title+'</h3>'+
											'</div>'+
											'</a>'
			        		$('.note-board').append(context)
			        	}
			        	for (let i = 0 ; i < data.attend_list.length ; i++ ){
			        		let context = '<a href="'+data.attend_list[i].link+'">'+
											'<div class="each-note">'+
												'<i class="fa fa-thumb-tack" aria-hidden="true"></i>'+
												'<h3>'+data.attend_list[i].post_title+'</h3>'+
											'</div>'+
											'</a>'
			        		$('.note-board').append(context)
			        	}
			     		if(data.my_post.length == 0 && data.attend_list.length == 0){
			     			$('.note-board').html('<div class="each-note">目前沒有活動</div>')
			     		}
			           /* $('.note').html('<li style="padding: 10px">'+data+'</li>')*/
			            //setTimeout(()=>{window.location = '/'},2000)
			        }
			    })
			})

		}())
	</script>
	<script src = "js/index_app.js">
	</script>
</body>
</html>